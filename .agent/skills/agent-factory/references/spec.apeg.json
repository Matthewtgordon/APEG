{
  "project": {
    "name": "APEG",
    "updated": "2025-12-29",
    "one_liner": "APEG orchestrates SEO updates, ad campaigns, and metrics feedback across Shopify using EcomAgent, N8N, and Meta Ads.",
    "stack": {
      "language": "Python",
      "version": "3.11+",
      "framework": "FastAPI",
      "database": "SQLite"
    },
    "architecture": "Async master orchestrator with sync agent wrappers (asyncio.to_thread)"
  },
  "agents": {
    "always": [
      "Wrap sync EcomAgent calls with asyncio.to_thread to preserve async architecture.",
      "Use Shopify GraphQL SEO input object product.seo { title, description }.",
      "Require APEG_ENV and APEG_ALLOW_WRITES=YES for any write path.",
      "Keep human approval workflow (Google Sheets staging) in place for Shopify writes."
    ],
    "ask_first": [
      "Add or change environment variables in .env.example.",
      "Add new dependencies or change package strategy (EcomAgent packaging or pip installs).",
      "Modify bulk operation sequencing or locking behavior.",
      "Change Etsy integration approach (GPL isolation vs custom API)."
    ],
    "never": [
      "Import GPL-3.0 etsyv3 into the APEG codebase.",
      "Bypass approval workflow for Shopify writes.",
      "Use product.metafields.seo.title (invalid SEO field mapping).",
      "Commit secrets or credentials."
    ],
    "key_files": [
      {"purpose": "Entry point", "path": "src/apeg_core/main.py"},
      {"purpose": "SEO orchestrator", "path": "src/apeg_core/agents/seo_orchestrator.py"},
      {"purpose": "Advertising agent", "path": "src/apeg_core/agents/advertising_agent.py"},
      {"purpose": "Metrics collector", "path": "src/apeg_core/metrics/collector.py"},
      {"purpose": "DB schema", "path": "src/apeg_core/db/schema.sql"}
    ]
  },
  "context": {
    "generated": "2026-01-06 05:15Z",
    "immediate_action": "Update .env.example with any new required keys (no secrets).",
    "immediate_file": ".env.example",
    "immediate_why": "Environment parity is a Phase 0 gate in the integration spec (Section 1.8).",
    "execplan_path": ".agent/plans/EXECPLAN-phase-0-cutover.md",
    "last_checkpoint": "2026-01-06 05:15Z",
    "red_lines": [
      "No GPL-3.0 dependencies in APEG; isolate Etsy or use REST.",
      "Do not bypass Google Sheets staging and human approval for Shopify writes.",
      "Use product.seo { title, description } for Shopify GraphQL SEO updates.",
      "Writes require APEG_ALLOW_WRITES=YES and APEG_ENV set."
    ],
    "blockers": ["Etsy integration blocked by GPL-3.0 etsyv3 license."]
  },
  "runbook": {
    "metadata": {
      "repo_root": "/home/matt/repos/APEG",
      "shell": "bash",
      "env_file": ".env.example"
    },
    "commands": [
      {
        "id": "env.activate",
        "action": "Activate venv",
        "command": "source .venv/bin/activate",
        "scope": "setup",
        "preconditions": "venv exists",
        "expected": "Shell prompt shows (.venv)",
        "side_effects": "shell state changes",
        "safe": "yes"
      },
      {
        "id": "dev.server",
        "action": "Start APEG API server (reload)",
        "command": "PYTHONPATH=. uvicorn src.apeg_core.main:app --reload --host 0.0.0.0 --port 8000",
        "scope": "dev",
        "preconditions": "deps installed; env vars set",
        "expected": "Uvicorn running on http://0.0.0.0:8000",
        "side_effects": "opens port 8000",
        "safe": "yes"
      },
      {
        "id": "test.all",
        "action": "Run full test suite",
        "command": "PYTHONPATH=. pytest -v",
        "scope": "test",
        "preconditions": "deps installed; env set if needed",
        "expected": "All tests pass",
        "side_effects": "none",
        "safe": "yes"
      },
      {
        "id": "test.ci",
        "action": "Run CI coverage gate",
        "command": "pytest --cov=apeg --cov-fail-under=75",
        "scope": "test",
        "preconditions": "deps installed",
        "expected": "Coverage >= 75%",
        "side_effects": "none",
        "safe": "yes"
      },
      {
        "id": "integration.safe_writes",
        "action": "Verify Shopify safe writes (Phase 2 integration)",
        "command": "PYTHONPATH=. python tests/integration/verify_phase2_safe_writes.py",
        "scope": "integration",
        "preconditions": "Redis running; DEMO safety gates",
        "expected": "Exit 0",
        "side_effects": "Shopify API calls",
        "safe": "no"
      },
      {
        "id": "ecomagent.install_editable",
        "action": "Install EcomAgent as editable package",
        "command": "cd ../EcomAgent && pip install -e .",
        "scope": "integration",
        "preconditions": "EcomAgent repo present",
        "expected": "ecomagent installed",
        "side_effects": "installs package",
        "safe": "yes"
      },
      {
        "id": "ecomagent.verify_import",
        "action": "Verify EcomAgent import",
        "command": "python -c \"from src.seo_engine.engine import SEOEngine; print('Import successful')\"",
        "scope": "integration",
        "preconditions": "EcomAgent installed",
        "expected": "Import successful",
        "side_effects": "none",
        "safe": "yes"
      }
    ],
    "command_args": [
      {
        "id": "test.single",
        "args": "{PATH}",
        "example": "PYTHONPATH=. pytest tests/unit/test_api_routes.py -v"
      }
    ]
  },
  "status": {
    "updated": "2026-01-06",
    "phases": [
      {"phase": "0", "name": "Config + Cutover Readiness", "status": "IN_PROGRESS", "goal": "Environment parity and cutover readiness (Section 1.8, Appendix F).", "evidence": "docs/PROJECT_PLAN_ACTIVE.md"},
      {"phase": "1", "name": "EcomAgent Standalone", "status": "COMPLETE", "goal": "EcomAgent runs standalone and produces JSONL outputs.", "evidence": "docs/ACCEPTANCE_TESTS.md"},
      {"phase": "2", "name": "n8n Integration", "status": "IN_PROGRESS", "goal": "n8n stages SEO changes and executes Shopify bulk ops.", "evidence": "docs/ACCEPTANCE_TESTS.md"},
      {"phase": "3", "name": "APEG Integration", "status": "IN_PROGRESS", "goal": "APEG orchestrates EcomAgent with async wrapper and locks.", "evidence": "docs/PROJECT_PLAN_ACTIVE.md"},
      {"phase": "4", "name": "Metrics Collection", "status": "IN_PROGRESS", "goal": "Daily metrics collection into SQLite/JSONL.", "evidence": "docs/PROJECT_PLAN_ACTIVE.md"},
      {"phase": "5", "name": "Feedback Loop", "status": "IN_PROGRESS", "goal": "Candidate selection and challenger generation operational.", "evidence": "docs/PROJECT_PLAN_ACTIVE.md"},
      {"phase": "6", "name": "Advertising Agent", "status": "NOT_STARTED", "goal": "Meta campaign creation and tracking.", "evidence": "docs/PROJECT_PLAN_ACTIVE.md"}
    ],
    "current_phase": {
      "phase": "0",
      "name": "Config + Cutover Readiness",
      "goal": "Enforce environment parity and complete demo-to-live readiness checks.",
      "evidence_targets": [
        {"label": "ENV-PARITY", "path": "docs/ENVIRONMENT.md"},
        {"label": "ACCEPTANCE", "path": "docs/ACCEPTANCE_TESTS.md"}
      ],
      "risks": [
        "Environment parity drift across .env templates",
        "Demo-to-live cutover misconfiguration",
        "Etsy integration blocked by GPL-3.0 etsyv3"
      ],
      "notes": [
        "Current phase sourced from docs/PROJECT_PLAN_ACTIVE.md",
        "Spec status: PRODUCTION READY (Demo-to-Live)"
      ]
    }
  }
}
